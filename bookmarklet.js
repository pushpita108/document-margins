javascript:(function(){const API_KEY_STORAGE='_marginalia_api_key';let API_KEY=localStorage.getItem(API_KEY_STORAGE);if(!API_KEY){API_KEY=prompt('Enter your Google Gemini API key (get one at https://aistudio.google.com/apikey):');if(!API_KEY)return alert('API key is required for Document Margins to work.');localStorage.setItem(API_KEY_STORAGE,API_KEY)}const STORAGE_KEY='_marginalia_notes';let notes=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");if(!document.getElementById('m-styles')){const s=document.createElement('style');s.id='m-styles';s.innerHTML='.margin-note{position:absolute;right:20px;width:320px;background:#fff;border-left:4px solid #4285f4;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:14px;z-index:999999;font-family:-apple-system,BlinkMacSystemFont,sans-serif;border-radius:6px}.m-panel{position:fixed;top:10px;right:20px;z-index:1000000;background:#1a1a1a;color:#fff;padding:10px;border-radius:8px;display:flex;gap:10px;box-shadow:0 2px 10px rgba(0,0,0,0.3)}.m-btn{cursor:pointer;border:none;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:bold}.m-sum{background:#4285f4;color:white}.m-close-note{float:right;cursor:pointer;font-weight:bold;color:#ccc;border:none;background:none;font-size:18px;line-height:1}.m-close-note:hover{color:#ff4d4d}.chat-area{font-size:13px;max-height:250px;overflow-y:auto;line-height:1.5}.chat-area .msg{margin:8px 0;padding:8px 10px;border-radius:6px}.chat-area .msg.user{background:#e3f2fd;border-left:3px solid #2196f3}.chat-area .msg.ai{background:#f5f5f5;border-left:3px solid #4caf50}.chat-area .msg-role{font-weight:600;font-size:11px;text-transform:uppercase;margin-bottom:4px;color:#666}.chat-area .msg.user .msg-role{color:#1976d2}.chat-area .msg.ai .msg-role{color:#388e3c}.chat-area h1,.chat-area h2,.chat-area h3{margin:8px 0 4px;font-size:14px;font-weight:600;color:#333}.chat-area ul,.chat-area ol{margin:4px 0;padding-left:18px}.chat-area li{margin:2px 0}.chat-area code{background:#e8e8e8;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:12px}.chat-area pre{background:#2d2d2d;color:#f8f8f2;padding:8px;border-radius:4px;overflow-x:auto;font-size:11px;margin:6px 0}.chat-area pre code{background:none;padding:0;color:inherit}.chat-area p{margin:4px 0}.chat-area strong{font-weight:600}.chat-area em{font-style:italic}';document.head.appendChild(s)}const md2html=(t)=>t.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>').replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>').replace(/^[\*\-] (.+)$/gm,'<li>$1</li>').replace(/^\d+\. (.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>)/s,'<ul>$1</ul>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>').replace(/^(.+)$/gm,(m)=>m.startsWith('<')?m:`<p>${m}</p>`);const renderHistory=(h)=>h.map(m=>{const isAI=m.role==='Gemini';const c=isAI?md2html(m.text):m.text.replace(/</g,'&lt;').replace(/>/g,'&gt;');return `<div class="msg ${isAI?'ai':'user'}"><div class="msg-role">${m.role}</div><div class="msg-content">${c}</div></div>`}).join('');const generateAISummary=async()=>{if(notes.length===0)return alert("No notes to summarize!");const btn=document.getElementById('sum-btn');btn.innerText="Reading Full Doc & Notes...";const fullDocumentBody=document.body.innerText.replace(/\s+/g,' ').substring(0,15000);const noteContext=notes.map((n,i)=>`[Interaction ${i+1}]\nHighlighted Text: ${n.highlight}\nDiscussion: ${n.history.map(h=>`${h.role}: ${h.text}`).join(' ')}`).join('\n\n');const synthesisPrompt=`TASK: Generate a comprehensive Executive Summary of the provided document and my related research notes.\nDOCUMENT TITLE: ${document.title}\nFULL DOCUMENT CONTENT (SAMPLED): ${fullDocumentBody}\n\nMY RESEARCH NOTES & CHATS:\n${noteContext}\n\nINSTRUCTIONS:\n1. Synthesize the core message of the document.\n2. Specifically integrate the insights gained from the research notes/conversations.\n3. Explain how the highlighted sections relate to the document's overall conclusion.\n4. Provide a "Thematic Synthesis" section.`;try{const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:synthesisPrompt}]}]})});const data=await res.json();if(!res.ok||!data.candidates?.[0]?.content?.parts?.[0]?.text){alert("API Error: "+(data.error?.message||`HTTP ${res.status}`));return}const aiSummary=data.candidates[0].content.parts[0].text;const blob=new Blob([`FINAL SYNTHESIS: ${document.title}\n\n${aiSummary}`],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Full_Synthesis_${document.domain}.txt`;a.click()}catch(e){alert("Synthesis failed.")}finally{btn.innerText="\u2728 AI Synthesis"}};const injectNote=(noteData,index)=>{const note=document.createElement('div');note.className='margin-note';note.style.top=noteData.top+'px';note.innerHTML=`<button class="m-close-note">\u00d7</button><div style="font-style:italic;font-size:11px;color:#666;margin-bottom:5px">"${noteData.highlight.substring(0,30)}..."</div><div class="chat-area">${renderHistory(noteData.history)}</div><textarea style="width:100%;font-size:12px;margin-top:8px" placeholder="Ask follow-up..."></textarea><button class="ask" style="width:100%;margin-top:4px;background:#4285f4;color:white;border:none;cursor:pointer;padding:3px">Ask</button>`;document.body.appendChild(note);note.querySelector('.m-close-note').onclick=()=>{notes.splice(index,1);localStorage.setItem(STORAGE_KEY,JSON.stringify(notes));note.remove()};note.querySelector('.ask').onclick=async()=>{const input=note.querySelector('textarea');const userText=input.value;if(!userText)return;noteData.history.push({role:'User',text:userText});note.querySelector('.chat-area').innerHTML=renderHistory(noteData.history);input.value='';const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`Full Doc: ${document.body.innerText.substring(0,4000)}\n\nHighlight: ${noteData.highlight}\n\nQuestion: ${userText}`}]}]})});const d=await res.json();if(!res.ok||!d.candidates?.[0]?.content?.parts?.[0]?.text){alert("API Error: "+(d.error?.message||`HTTP ${res.status}`));return}const aiText=d.candidates[0].content.parts[0].text;noteData.history.push({role:'Gemini',text:aiText});note.querySelector('.chat-area').innerHTML=renderHistory(noteData.history);localStorage.setItem(STORAGE_KEY,JSON.stringify(notes))}};if(!document.getElementById('m-panel')){const panel=document.createElement('div');panel.id='m-panel';panel.className='m-panel';panel.innerHTML=`<button class="m-btn m-sum" id="sum-btn">\u2728 AI Synthesis</button><button class="m-btn m-clr" id="clr-btn" style="background:#333;color:#ccc">Clear All</button>`;document.body.appendChild(panel);panel.querySelector('#clr-btn').onclick=()=>{if(confirm("Clear all?")){localStorage.removeItem(STORAGE_KEY);location.reload()}};panel.querySelector('#sum-btn').onclick=generateAISummary}document.querySelectorAll('.margin-note').forEach(n=>n.remove());notes.forEach((n,i)=>injectNote(n,i));const sel=window.getSelection().toString().trim();if(sel){const rect=window.getSelection().getRangeAt(0).getBoundingClientRect();const newNote={top:window.scrollY+rect.top,highlight:sel,history:[]};notes.push(newNote);localStorage.setItem(STORAGE_KEY,JSON.stringify(notes));injectNote(newNote,notes.length-1)}})();
